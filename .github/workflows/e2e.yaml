name: E2E Tests

on:
  push:
    branches: [main]

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install kind
        run: go install sigs.k8s.io/kind@v0.24.0

      - name: Install kubectl
        run: |
          curl -Lo /usr/local/bin/kubectl "https://dl.k8s.io/release/$(curl -Ls https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x /usr/local/bin/kubectl

      - name: Create kind cluster
        run: kind create cluster --config test/e2e/kind-config.yaml

      - name: Build docker image
        run: docker build -t gungnir-operator:latest .

      - name: Load image into kind
        run: kind load docker-image gungnir-operator:latest

      - name: Install CRD
        run: kubectl apply -f charts/gungnir-operator/crds/

      - name: Deploy operator via Helm
        run: |
          helm install gungnir-operator charts/gungnir-operator/ \
            --set image.repository=gungnir-operator \
            --set image.tag=latest \
            --set image.pullPolicy=Never

      - name: Wait for operator ready
        run: |
          kubectl rollout status deployment/gungnir-operator \
            --timeout=120s

      - name: Run e2e tests
        run: bash test/e2e/run-all.sh

      - name: Cleanup
        if: always()
        run: kind delete cluster
